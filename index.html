<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Super Admin Panel</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f1f5f9;
            --surface-light: #ffffff;
            --text-primary-light: #0f172a;
            --text-secondary-light: #64748b;
            --border-light: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-blue-darker: #2563eb;
            --danger-light: #ef4444;

            --bg-dark: #020617;
            --surface-dark: #0f172a;
            --text-primary-dark: #e2e8f0;
            --text-secondary-dark: #94a3b8;
            --border-dark: #1e293b;
            --danger-dark: #f87171;
        }

        /* Dark mode por defecto */
        body {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-dark);
            --danger-color: var(--danger-dark);
        }

        /* Estilos Light mode (si se implementa toggle) */
        body.light-mode {
             --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border-color: var(--border-light);
            --danger-color: var(--danger-light);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }

        @keyframes pulse { 0%{transform: scale(1); opacity: .9}50%{transform: scale(1.05); opacity: 1}100%{transform: scale(1); opacity: .9} }
        @keyframes subtle-glow { 0%,100%{filter: drop-shadow(0 0 8px rgba(138,43,226,.7))}50%{filter: drop-shadow(0 0 16px rgba(57,255,20,.7))} }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- Estilos Splash Screen (Opcional, pero recomendado) --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity .5s ease-out }
        #splash-screen img { width: 150px; height: 150px; animation: pulse 2.5s infinite ease-in-out }

        /* --- Estilos Login View --- */
        #login-view {
            display: none; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; padding: 20px; background-color: var(--bg);
        }
        .login-card { /* ... (similar a antes, ajusta si quieres) ... */
            background-color: transparent; box-shadow: none; border: none;
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-card .logo img { width: 100px; height: 100px; margin-bottom: 20px; filter: grayscale(50%) opacity(80%); } /* Logo diferente o con filtro */
        .login-card h2 { margin-bottom: 10px; font-size: 1.6em; font-weight: 700; color: var(--text-primary); }
        .login-card p { margin-bottom: 30px; color: var(--text-secondary); }
        .login-card .form-group { text-align: left; margin-bottom: 15px; }
        .login-card .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-secondary); font-size: 0.9em; }
        .login-card .form-group input { /* ... (similar a antes) ... */
             width: 100%; padding: 15px; font-size: 1em; border-radius: 8px;
             border: 1px solid #334155;
             background-color: #1e293b;
             color: var(--text-primary);
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-card .form-group input:focus { /* ... (similar a antes) ... */
             border-color: var(--accent-blue); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .login-card .btn-primary { /* ... (similar a antes) ... */
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background-color: var(--accent-blue);
            color: white;
            transition: background-color 0.2s;
            margin-top: 10px;
        }
        .login-card .btn-primary:hover { background-color: var(--accent-blue-darker); }
        .login-card .btn-primary:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }

        /* --- Estilos App Container (Placeholder) --- */
        #app-container { display: none; flex-direction: column; height: 100%; width: 100%; }
        .main-header { /* ... (similar a antes, ajusta textos/iconos) ... */
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
            background-color: var(--surface); border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .header-title { font-size: 1.2em; font-weight: 600; color: var(--text-primary); }
        .header-controls button { /* ... (estilo botón logout) ... */
            background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        main { flex-grow: 1; overflow-y: auto; }
        .container { padding: 20px; }
        .section-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .fab { /* ... (estilo FAB para añadir empresa) ... */
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--accent-blue);
            color: white; border-radius: 50%; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 160;
        }
        /* --- Otros estilos generales (botones, modales, etc.) --- */
        .btn-primary { background-color: var(--accent-blue); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        .btn-secondary { background-color: transparent; color: var(--accent-blue); border: 1px solid var(--accent-blue); padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        .btn-danger { background-color: var(--danger-color); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }

        /* --- ESTILOS CORREGIDOS PARA MODALES --- */
        .modal-view, .modal-overlay {
            position: fixed; /* Asegura posición fija */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200; /* Pone el modal por encima */
        }
        .modal-view {
            background-color: var(--bg);
            transform: translateX(100%); /* Empieza fuera de pantalla */
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .modal-view.active {
            transform: translateX(0); /* Lo trae a la pantalla */
        }
        .modal-overlay {
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
         }
         .modal-overlay.active {
             display: flex; /* Muestra */
             opacity: 1;
         }
         .modal-content {
             background-color: var(--surface);
             padding: 20px;
             border-radius: 12px;
             width: 90%;
             max-width: 500px;
             box-shadow: 0 10px 30px rgba(0,0,0,0.2);
         }
         .modal-header {
             display: flex; align-items: center; padding: 15px 20px;
             background-color: var(--surface); border-bottom: 1px solid var(--border-color);
             flex-shrink: 0; position: sticky; top: 0; z-index: 1; /* Para que quede arriba al hacer scroll */
         }
         .modal-header button { background: none; border: none; color: var(--text-primary); cursor: pointer; margin-right: 15px; }
         .modal-title { font-size: 1.2em; font-weight: 600; }
         .modal-content-wrapper { flex-grow: 1; overflow-y: auto; padding: 20px; }
         .action-buttons {
             background-color: var(--surface); border-top: 1px solid var(--border-color);
             padding: 15px 20px; display: flex; gap: 10px; margin-top: auto;
             position: sticky; bottom: 0; flex-shrink: 0;
         }
         .action-buttons button { flex-grow: 1; padding: 15px; font-size: 1em; font-weight: 600; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
         .action-buttons button:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
         /* --- FIN ESTILOS CORREGIDOS MODALES --- */

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 10px 18px; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); font-size: 0.9em; opacity: 0; transform: translateY(-15px); transition: opacity .3s, transform .3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.toast-error { background-color: var(--danger-color); }
        .toast.toast-success { background-color: var(--accent-blue); } /* Ajusta color si quieres */

        /* Estilos específicos del formulario de empresa */
        #companyFormModal .form-group { margin-bottom: 18px; }
        #companyFormModal .form-group label { margin-bottom: 6px; font-size: 0.9em; }
        #companyFormModal .form-group input,
        #companyFormModal .form-group select,
        #companyFormModal .form-group textarea {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface);
            color: var(--text-primary);
        }
        #companyFormModal .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        #companyFormModal .toggle-switch { /* ... estilos toggle ... */ }
        #companyFormModal .section-title { margin-top: 25px; margin-bottom: 15px; padding-bottom: 8px; font-size: 1.1em; }

        /* --- NUEVO: Estilos para Tabs (Demo/Pro) --- */
        .plan-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 25px;
        }
        .plan-type-selector input[type="radio"] {
            display: none;
        }
        .plan-type-selector label {
            display: block;
            padding: 15px;
            border: 2px solid var(--border-color);
            background-color: var(--surface);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .plan-type-selector label:hover {
            border-color: var(--accent-blue);
        }
        .plan-type-selector input[type="radio"]:checked + label {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }
        .plan-fields-container {
            display: none; /* Oculto por defecto */
        }
        /* --- Fin Estilos Tabs --- */

        /* Estilos para lista de empresas */
        #companies-list .company-card {
             background-color: var(--surface); padding: 15px 20px; border-radius: 12px;
             margin-bottom: 12px; border: 1px solid var(--border-color);
             display: flex; justify-content: space-between; align-items: center;
             cursor: pointer; transition: box-shadow 0.2s, transform 0.2s;
        }
        #companies-list .company-card:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); /* Sombra azulada en modo oscuro */
        }
        #companies-list .company-card h4 { margin: 0 0 4px; font-size: 1.1em; }
        #companies-list .company-card p { font-size: 0.85em; color: var(--text-secondary); margin: 0; }
        #companies-list .company-card .company-actions button { /* Estilo botones editar/ver */ }

    </style>
</head>
<body>

    <div id="splash-screen" style="display: none;"> <!-- Opcional -->
        <img src="URL_DE_TU_LOGO_SI_QUIERES" alt="Loading...">
    </div>

    <div id="login-view">
        <div class="login-card">
            <div class="logo">
                <img src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo" style="width: 140px; height: 140px; margin-bottom: 30px; animation: subtle-glow 5s ease-in-out infinite;"> <!-- Logo igual a admin_app -->
            </div>
            <h2>Super Admin Panel</h2>
            <p>Acceso exclusivo.</p>
            <form id="login-form">
                <div class="form-group">
                    <label for="superadmin-email">Email</label>
                    <input type="email" id="superadmin-email" required>
                </div>
                <div class="form-group">
                    <label for="superadmin-password">Contraseña</label>
                    <input type="password" id="superadmin-password" required>
                </div>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <header class="main-header">
            <span class="header-title">Gestión de Empresas</span>
            <div class="header-controls">
                <button id="logout-btn" title="Cerrar Sesión"><i data-lucide="log-out"></i></button>
            </div>
        </header>
        <main>
            <div id="companies-view" class="view active container">
                <h2 class="section-title">Empresas Registradas</h2>
                <div id="companies-list">
                    <p>Cargando empresas...</p>
                    <!-- La lista de empresas se cargará aquí -->
                </div>
            </div>
            <!-- Aquí irán otras vistas si son necesarias -->
        </main>
        <button class="fab" id="addCompanyBtn" title="Añadir Nueva Empresa"><i data-lucide="plus"></i></button>
    </div>

    <!-- Modales -->
            <div id="companyFormModal" class="modal-view"></div>
    <div id="toast-container"></div>

    <script type="module">
        // Importa Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, getIdToken } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js"; // Añadido getIdToken
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";

        // --- Configuración de Firebase (Usa la MISMA que tus otras apps) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRxJjpH6PBi-GRxOXS8klv-8v91sO4X-Y",
            authDomain: "lumix-financas-app.firebaseapp.com",
            projectId: "lumix-financas-app",
            storageBucket: "lumix-financas-app.firebasestorage.app", // O .appspot.com si es el caso
            messagingSenderId: "463777495321",
            appId: "1:463777495321:web:106118f53f56abd206ed88" // Asegúrate que sea el correcto
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let functions; // Inicialización retrasada

        // --- (NUEVO) Configuración de Monedas para América ---
        const CURRENCY_CONFIGS = {
            "USD": { name: "Dólar Americano", symbol: "$", country: "EE.UU." },
            "CAD": { name: "Dólar Canadiense", symbol: "C$", country: "Canadá" },
            "MXN": { name: "Peso Mexicano", symbol: "MXN$", country: "México" },
            "GTQ": { name: "Quetzal Guatemalteco", symbol: "Q", country: "Guatemala" },
            "HNL": { name: "Lempira Hondureña", symbol: "L", country: "Honduras" },
            "NIO": { name: "Córdoba Nicaragüense", symbol: "C$", country: "Nicaragua" },
            "CRC": { name: "Colón Costarricense", symbol: "₡", country: "Costa Rica" },
            "PAB": { name: "Balboa Panameño", symbol: "B/.", country: "Panamá" },
            "DOP": { name: "Peso Dominicano", symbol: "RD$", country: "Rep. Dominicana" },
            "COP": { name: "Peso Colombiano", symbol: "COP$", country: "Colombia" },
            "VES": { name: "Bolívar Soberano", symbol: "Bs.", country: "Venezuela" },
            "PEN": { name: "Sol Peruano", symbol: "S/", country: "Perú" },
            "BOB": { name: "Boliviano", symbol: "Bs.", country: "Bolivia" },
            "CLP": { name: "Peso Chileno", symbol: "CLP$", country: "Chile" },
            "PYG": { name: "Guaraní Paraguayo", symbol: "₲", country: "Paraguay" },
            "ARS": { name: "Peso Argentino", symbol: "ARS$", country: "Argentina" },
            "UYU": { name: "Peso Uruguayo", symbol: "$U", country: "Uruguay" },
            "BRL": { name: "Real Brasileiro", symbol: "R$", country: "Brasil" }
            // Puedes añadir más si es necesario
        };

        // --- Variables Globales ---
        let allCompanies = [];
        let currentSuperAdmin = null;

        // --- Funciones Principales (Implementación básica) ---

        async function handleSuperAdminLogin(event) {
            event.preventDefault();
            const emailInput = document.getElementById('superadmin-email');
            const passwordInput = document.getElementById('superadmin-password');
            const loginButton = document.querySelector('#login-form button[type="submit"]');
            const originalButtonHTML = loginButton.innerHTML;
            const email = emailInput.value.trim();
            const pass = passwordInput.value;

            if (!email || !pass) { showToast('Email y contraseña requeridos.', true); return; }

            loginButton.disabled = true;
            loginButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite; margin-right: 8px;"></i> Entrando...`;
            lucide.createIcons({ nodes: [loginButton.querySelector('i')] });


            try {
                // Intenta iniciar sesión
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                // IMPORTANTE: Aquí deberíamos verificar si este usuario es REALMENTE un Super Admin.
                // Por ahora, asumiremos que si logra iniciar sesión en esta app, lo es.
                // La verificación real se haría con Custom Claims (más adelante).
                console.log("Login Super Admin OK:", userCredential.user.uid);
                // onAuthStateChanged se encargará del resto

            } catch (error) {
                console.error("Error Login Super Admin:", error);
                showToast('Email o contraseña incorrectos.', true);
                loginButton.disabled = false;
                loginButton.innerHTML = originalButtonHTML;
            }
        }

        function showSuperAdminApp(user) {
            currentSuperAdmin = user; // Guarda el usuario Super Admin
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Llama a funciones para cargar datos y configurar listeners
            loadCompanies();
            setupSuperAdminEventListeners(); // <- Llamada movida aquí
            lucide.createIcons();
        }

        function showLoginView() {
            currentSuperAdmin = null;
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-view').style.display = 'flex';
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.removeEventListener('submit', handleSuperAdminLogin); // Limpia anterior
                loginForm.addEventListener('submit', handleSuperAdminLogin);
            }
            // Asegura íconos en login si tienes alguno
            const loginViewIcons = document.getElementById('login-view').querySelectorAll('[data-lucide]');
            if(loginViewIcons.length > 0) lucide.createIcons({nodes: loginViewIcons});
        }

        function loadCompanies() {
            const listContainer = document.getElementById('companies-list');
            listContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Cargando...</p>'; // Indicador de carga mejorado

            // Escucha la colección /companies
            onSnapshot(collection(db, 'companies'), (snapshot) => {
                allCompanies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCompaniesList();
            }, (error) => {
                console.error("Error al cargar empresas:", error);
                listContainer.innerHTML = '<p style="text-align: center; color: var(--danger-color); padding: 20px;">Error al cargar datos.</p>';
            });
        }

        function renderCompaniesList() {
            const listContainer = document.getElementById('companies-list');
            if (allCompanies.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">No hay empresas registradas todavía. Haz clic en el botón "+" para añadir la primera.</p>';
                return;
            }
            // Lista mejorada con estilo de tarjeta
            listContainer.innerHTML = allCompanies.map(company => `
                <div class="company-card" data-company-id="${company.id}">
                    <div>
                        <h4>${company.name || 'Nombre no definido'}</h4>
                        <!-- Lógica de renderizado de plan actualizada -->
                        <p>${renderPlanInfo(company.plan)}</p>
                    </div>
                    <div>
                        <button class="header-btn" data-action="edit" title="Editar Empresa"><i data-lucide="edit"></i></button>
                        <!-- <button class="header-btn" data-action="view" title="Ver Detalles"><i data-lucide="eye"></i></button> -->
                    </div>
                </div>
            `).join('');
            // Añade listeners a los nuevos botones
             listContainer.querySelectorAll('.company-card button[data-action="edit"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita que el clic en el botón active el clic en la tarjeta
                    const companyId = e.currentTarget.closest('.company-card').dataset.companyId;
                    showCompanyFormModal(companyId); // Abre modal en modo edición
                });
            });
             // Listener para la tarjeta completa (podría llevar a una vista de detalles en el futuro)
            listContainer.querySelectorAll('.company-card').forEach(card => {
                card.addEventListener('click', (e) => {
                     if (e.target.closest('button')) return; // No hacer nada si se hizo clic en un botón
                     const companyId = card.dataset.companyId;
                     console.log("Ver detalles de la empresa (Implementación futura):", companyId);
                     showToast(`Ver detalles de ${allCompanies.find(c=>c.id===companyId)?.name} (Implementación futura)`, false)
                });
            });

            lucide.createIcons({ nodes: listContainer.querySelectorAll('[data-lucide]') });
        }

        // --- NUEVO: Helper para mostrar info del plan ---
        function renderPlanInfo(plan) {
            if (!plan) return 'Plan: N/A';

            let collectorLimitText = 'Limite: N/A';
            if (plan.collectorLimit) {
                collectorLimitText = plan.collectorLimit === -1 ? 'Cobradores Ilimitados' : `Limite: ${plan.collectorLimit} cobrador(es)`;
            }

            if (plan.type === 'demo') {
                return `Plan: DEMO (${plan.duration || 'N/A'}) - ${collectorLimitText}`;
            }
            if (plan.type === 'pro') {
                const planValue = plan.value ? `(${plan.value} ${plan.currency || ''})` : '';
                return `Plan: PRO (${plan.plan || 'N/A'} ${planValue}) - ${collectorLimitText}`;
            }
            // Fallback para el formato antiguo
            return `Plan: ${plan.text || plan.duration || 'N/A'} - Valor: ${plan.value || 'N/A'}`;
        }
        // --- FIN Helper ---

        function showCompanyFormModal(companyId = null) {
            const isEditMode = companyId !== null;
            const companyData = isEditMode ? allCompanies.find(c => c.id === companyId) : {}; // Obtiene datos si edita

            const modal = document.getElementById('companyFormModal');
            if (!modal) return;

            const modalTitle = isEditMode ? 'Editar Empresa' : 'Registrar Nova Empresa Financeira';
            const saveButtonText = isEditMode ? 'Salvar Alterações' : 'Criar Empresa e Admin';

            // --- Opciones para los nuevos selects ---
            const demoDurationOptions = [
                { value: '1d', text: '1 Dia' },
                { value: '2d', text: '2 Dias' },
                { value: '3d', text: '3 Dias' },
                { value: '5d', text: '5 Dias' },
                { value: '7d', text: '7 Dias' },
                { value: '15d', text: '15 Dias' }
            ];

            const proPlanOptions = [
                { value: '1m', text: 'Mensal' },
                { value: '3m', text: 'Trimestral' },
                { value: '6m', text: 'Semestral' },
                { value: '1y', text: 'Anual' }
            ];

            const collectorLimitOptions = [
                { value: '1', text: '1 Cobrador' },
                { value: '3', text: '3 Cobradores' },
                { value: '5', text: '5 Cobradores' },
                { value: 'custom', text: 'Personalizado' },
                // { value: '-1', text: 'Ilimitado' } // Opción ilimitada (añadida si se necesita)
            ];

            const currencyOptions = Object.entries(CURRENCY_CONFIGS).map(([code, config]) => {
                // Selecciona BRL por defecto si no hay nada, o la moneda guardada
                const selected = (companyData.settings?.currency || 'BRL') === code ? 'selected' : '';
                return `<option value="${code}" ${selected}>${config.country} (${config.symbol} ${code})</option>`;
            }).sort((a, b) => a.localeCompare(b)).join(''); // Ordena alfabéticamente por país
            // --- Fin Opciones ---


            // --- HTML del Modal RECONSTRUIDO ---
            modal.innerHTML = `
                <header class="modal-header">
                    <button id="closeCompanyFormModal"><i data-lucide="arrow-left"></i></button>
                    <span class="modal-title">${modalTitle}</span>
                </header>
                <div class="modal-content-wrapper container">
                    <form id="company-form">

                        <!-- Paso 1: Datos de la Empresa (Común) -->
                        <h3 class="section-title" style="margin-top: 10px; font-size: 1.1em;">Dados da Empresa</h3>
                        <div class="form-group">
                            <label for="company-name">Nome da Empresa Financeira</label>
                            <input type="text" id="company-name" required value="${companyData.name || ''}">
                        </div>
                        <div class="form-group grid-2">
                             <div>
                                <label for="company-default-interest">Juros Padrão (%)</label>
                                <input type="number" id="company-default-interest" step="0.1" value="${companyData.settings?.defaultInterest || '20'}" ${isEditMode ? 'readonly' : ''}> <!-- No editable en modo edición por ahora -->
                            </div>
                            <div>
                                <label for="company-currency">Moeda Principal</label>
                                <select id="company-currency" ${isEditMode ? 'disabled' : ''}> <!-- No editable en modo edición por ahora -->
                                     ${currencyOptions}
                                </select>
                            </div>
                        </div>

                        <!-- Paso 2: Tipo de Cuenta (Solo en Creación) -->
                        ${!isEditMode ? `
                        <h3 class="section-title" style="margin-top: 30px; font-size: 1.1em;">Tipo de Conta</h3>
                        <div class="plan-type-selector">
                            <input type="radio" id="plan-type-demo" name="plan-type" value="demo" checked>
                            <label for="plan-type-demo"><i data-lucide="play-circle"></i> Versão DEMO</label>

                            <input type="radio" id="plan-type-pro" name="plan-type" value="pro">
                            <label for="plan-type-pro"><i data-lucide="award"></i> Versão PRO</label>
                        </div>

                        <!-- Campos para DEMO -->
                        <div id="demo-form-fields" class="plan-fields-container">
                            <h3 class="section-title" style="margin-top: 30px; font-size: 1.1em;">Configurar DEMO</h3>
                            <div class="form-group">
                                <label for="demo-duration">Duração do Demo</label>
                                <select id="demo-duration">
                                    ${demoDurationOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="demo-collector-limit">Limite de Cobradores</label>
                                <select id="demo-collector-limit" class="collector-limit-select">
                                    ${collectorLimitOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group" id="demo-custom-limit-group" style="display: none;">
                                <label for="demo-custom-collector-limit">Número Exato de Cobradores</label>
                                <input type="number" id="demo-custom-collector-limit" placeholder="Ex: 10">
                            </div>
                        </div>

                        <!-- Campos para PRO -->
                        <div id="pro-form-fields" class="plan-fields-container">
                            <h3 class="section-title" style="margin-top: 30px; font-size: 1.1em;">Configurar PRO</h3>
                            <div class="form-group grid-2">
                                <div>
                                    <label for="pro-plan-type">Plano</label>
                                    <select id="pro-plan-type">
                                        ${proPlanOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label for="pro-plan-value">Valor do Plano</label>
                                    <input type="number" id="pro-plan-value" step="0.01" placeholder="Ex: 150.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="pro-collector-limit">Limite de Cobradores</label>
                                <select id="pro-collector-limit" class="collector-limit-select">
                                    ${collectorLimitOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group" id="pro-custom-limit-group" style="display: none;">
                                <label for="pro-custom-collector-limit">Número Exato de Cobradores</label>
                                <input type="number" id="pro-custom-collector-limit" placeholder="Ex: 10">
                            </div>
                        </div>
                        ` : ''}

                        <!-- Campos de Admin (Solo en Creación) -->
                        ${!isEditMode ? `
                        <h3 class="section-title" style="margin-top: 30px; font-size: 1.1em;">Dados do Administrador Principal</h3>
                        <div class="form-group">
                            <label for="admin-email">Email do Admin</label>
                            <input type="email" id="admin-email" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="admin-password">Senha Temporária do Admin</label>
                            <input type="password" id="admin-password" required autocomplete="new-password">
                            <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 5px;">Mínimo 6 caracteres.</p>
                        </div>
                        ` : ''}

                        <!-- Campos de Edición (Solo en Edición) -->
                        ${isEditMode ? `
                        <h3 class="section-title" style="margin-top: 30px; font-size: 1.1em;">Plano e Pagamento (Edição)</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: -15px; margin-bottom: 20px;">La edición detallada del plan (tipo, límites) se hará en un panel futuro. Por ahora, puedes editar el nombre y el valor.</p>
                        <div class="form-group">
                            <label>Valor Atual do Plano</label>
                            <input type="number" id="edit-plan-value" step="0.01" value="${companyData.plan?.value || '0'}">
                        </div>
                        ` : ''}

                    </form>
                </div>
                <div class="action-buttons">
                    <button id="saveCompanyBtn" class="btn-primary"><i data-lucide="save"></i> ${saveButtonText}</button>
                </div>
            `;
            // --- FIN HTML RECONSTRUIDO ---

            modal.classList.add('active');
            lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });

            // --- Event Listeners del Modal ---
            modal.querySelector('#closeCompanyFormModal').addEventListener('click', () => window.history.back());

            // --- NUEVOS Listeners para Lógica de Formulario ---
            if (!isEditMode) {
                const demoFields = modal.querySelector('#demo-form-fields');
                const proFields = modal.querySelector('#pro-form-fields');

                // Mostrar campos Demo por defecto
                demoFields.style.display = 'block';

                // Listener para tabs DEMO/PRO
                modal.querySelectorAll('input[name="plan-type"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        if (e.target.value === 'demo') {
                            demoFields.style.display = 'block';
                            proFields.style.display = 'none';
                        } else {
                            demoFields.style.display = 'none';
                            proFields.style.display = 'block';
                        }
                    });
                });

                // Listener para Límite de Cobradores (para ambos forms)
                modal.querySelectorAll('.collector-limit-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const isDemo = e.target.id === 'demo-collector-limit';
                        const customGroup = modal.querySelector(isDemo ? '#demo-custom-limit-group' : '#pro-custom-limit-group');
                        const customInput = modal.querySelector(isDemo ? '#demo-custom-collector-limit' : '#pro-custom-collector-limit');
                        if (e.target.value === 'custom') {
                            customGroup.style.display = 'block';
                            customInput.required = true; // Hace requerido el campo personalizado
                        } else {
                            customGroup.style.display = 'none';
                            customInput.required = false; // No es requerido si no es custom
                            customInput.value = ''; // Limpia el valor si se cambia
                        }
                    });
                });
            }
            // --- FIN NUEVOS Listeners ---


            // --- Listener de Guardado (ACTUALIZADO) ---
            modal.querySelector('#saveCompanyBtn').addEventListener('click', async (e) => {
                const saveButton = e.currentTarget;
                const originalButtonHTML = saveButton.innerHTML;

                // 1. Recolectar datos COMUNES
                const companyName = document.getElementById('company-name').value.trim();
                const defaultInterest = parseFloat(document.getElementById('company-default-interest').value) || 20;
                const currency = document.getElementById('company-currency').value || 'BRL';
                const requireGps = false; // Hardcoded por ahora

                const adminEmailInput = document.getElementById('admin-email');
                const adminPasswordInput = document.getElementById('admin-password');
                const adminEmail = adminEmailInput ? adminEmailInput.value.trim() : null;
                const adminPassword = adminPasswordInput ? adminPasswordInput.value : null;

                // Validaciones básicas
                if (!companyName) {
                    showToast('O nome da empresa é obrigatório.', true); return;
                }
                if (!isEditMode && (!adminEmail || !adminPassword || adminPassword.length < 6)) {
                    showToast('Email e senha (mín. 6 caracteres) para o admin são obrigatórios.', true); return;
                }

                // Deshabilita botón y muestra carga
                saveButton.disabled = true;
                saveButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> ${isEditMode ? 'Salvando...' : 'Criando...'}`;
                lucide.createIcons({ nodes: [saveButton.querySelector('i')] });

                // 2. Preparar datos
                const companySettings = { defaultInterest, currency, requireGps };
                let companyPlan = {}; // Objeto de plan vacío

                try {
                    if (isEditMode) {
                        // --- Lógica de Edición ---
                        // Solo actualiza el nombre y el valor del plan por ahora
                        const newPlanValue = parseFloat(document.getElementById('edit-plan-value').value);
                        if (isNaN(newPlanValue) || newPlanValue < 0) {
                             showToast('Valor do plano inválido.', true);
                             saveButton.disabled = false; saveButton.innerHTML = originalButtonHTML; return;
                        }
                        // Mantiene plan existente, actualiza valor
                        companyPlan = { ...companyData.plan, value: newPlanValue };

                        console.log("Modo Edição - Atualizando dados...");
                        await updateDoc(doc(db, 'companies', companyId), {
                             name: companyName,
                             plan: companyPlan // Solo actualizamos nombre y plan (que contiene el valor)
                             // Settings no se actualizan en edición por ahora
                        });
                        showToast('Empresa atualizada com sucesso!');
                        window.history.back();

                    } else {
                        // --- Lógica de Creación (NUEVA LÓGICA DE PLAN) ---
                        const accountType = modal.querySelector('input[name="plan-type"]:checked').value;
                        let collectorLimit = 0; // Inicializa
                        let collectorLimitType = ''; // Inicializa

                        if (accountType === 'demo') {
                            const duration = modal.querySelector('#demo-duration').value;
                            const limitSelect = modal.querySelector('#demo-collector-limit');
                            collectorLimitType = limitSelect.value;

                            if (collectorLimitType === 'custom') {
                                collectorLimit = parseInt(modal.querySelector('#demo-custom-collector-limit').value);
                                if (isNaN(collectorLimit) || collectorLimit <= 0) {
                                     showToast('Número de cobradores personalizado inválido.', true);
                                     saveButton.disabled = false; saveButton.innerHTML = originalButtonHTML; return;
                                }
                            } else {
                                collectorLimit = parseInt(collectorLimitType);
                            }

                            companyPlan = {
                                type: 'demo',
                                duration: duration, // Guarda '1d', '2d', etc.
                                text: `Demo (${modal.querySelector('#demo-duration option:checked').text})`,
                                collectorLimit: collectorLimit,
                                collectorLimitType: collectorLimitType, // Guarda '1', '3', '5' o 'custom'
                                value: 0, // Demos no tienen valor
                                currency: currency
                            };

                        } else if (accountType === 'pro') {
                            const planType = modal.querySelector('#pro-plan-type').value;
                            const planText = modal.querySelector('#pro-plan-type option:checked').text;
                            const planValueInput = modal.querySelector('#pro-plan-value');
                            const planValue = parseFloat(planValueInput.value);
                            const limitSelect = modal.querySelector('#pro-collector-limit');
                            collectorLimitType = limitSelect.value;

                            if (isNaN(planValue) || planValue < 0) { // Permitimos valor 0
                                showToast('Valor do plano inválido.', true);
                                saveButton.disabled = false; saveButton.innerHTML = originalButtonHTML; return;
                            }

                            if (collectorLimitType === 'custom') {
                                collectorLimit = parseInt(modal.querySelector('#pro-custom-collector-limit').value);
                                if (isNaN(collectorLimit) || collectorLimit <= 0) {
                                     showToast('Número de cobradores personalizado inválido.', true);
                                     saveButton.disabled = false; saveButton.innerHTML = originalButtonHTML; return;
                                }
                            } else {
                                collectorLimit = parseInt(collectorLimitType);
                            }

                            companyPlan = {
                                type: 'pro',
                                plan: planType, // Guarda '1m', '3m', etc.
                                text: `PRO (${planText})`,
                                collectorLimit: collectorLimit,
                                collectorLimitType: collectorLimitType, // Guarda '1', '3', '5' o 'custom'
                                value: planValue,
                                currency: currency
                            };
                        }

                        // Validar que se haya seleccionado un plan
                        if (!companyPlan.type) {
                            throw new Error('Erro ao processar o tipo de plano.');
                        }

                        // --- FIN LÓGICA NUEVA DE PLAN ---

                        const companyBaseData = {
                            name: companyName,
                            settings: companySettings,
                            plan: companyPlan // Envía el objeto de plan estructurado
                        };

                        // --- Llamada a Cloud Function (sin cambios en la llamada, solo en 'dataToSend') ---
                        console.log("Modo Criação - Chamando Cloud Function...");
                        try {
                            if (!auth.currentUser) throw new Error("Usuário Super Admin não autenticado.");

                            console.log("Forçando obtención/refresco del token ID...");
                            const idToken = await auth.currentUser.getIdToken(true);
                            console.log("Token ID obtenido/refrescado.");

                            const functionUrl = "https://us-central1-lumix-financas-app.cloudfunctions.net/createCompanyAndAdmin";

                            const dataToSend = {
                                companyData: companyBaseData, // Envía el nuevo objeto con plan detallado
                                adminEmail: adminEmail,
                                adminPassword: adminPassword
                            };

                            console.log("Datos a enviar (limpios):", JSON.stringify(dataToSend));

                            const response = await fetch(functionUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${idToken}`
                                },
                                body: JSON.stringify({ data: dataToSend })
                            });

                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                const errorMessage = errorData.error?.message || `Error HTTP ${response.status}: ${response.statusText}`;
                                throw new Error(errorMessage);
                            }

                            const resultWrapper = await response.json();
                            if (resultWrapper.error) throw new Error(resultWrapper.error.message);

                            const result = resultWrapper.result;
                            console.log("Resultado da Cloud Function:", result);

                            if (result.success) {
                                showToast(`Empresa "${companyName}" e Admin criados com sucesso!`);
                                window.history.back();
                            } else {
                                throw new Error(result.error || 'Erro desconhecido retornado pela Cloud Function.');
                            }

                        } catch (functionError) {
                            console.error("Erro ao chamar/executar a Cloud Function:", functionError);
                            showToast(`Erro ao criar empresa: ${functionError.message}`, true);
                            // Log completo para depuración
                            console.log("Detalles completos del Error:", functionError);
                        } finally {
                             // Reactiva el botón SOLO SI HUBO ERROR en la función
                             if (!saveButton.disabled) { // Si no se desactivó por error de validación
                                saveButton.disabled = false;
                                saveButton.innerHTML = originalButtonHTML;
                                if (document.body.contains(saveButton)) {
                                    lucide.createIcons({ nodes: [saveButton.querySelector('i')] });
                                }
                             }
                        }
                    }
                } catch (generalError) {
                    console.error("Error general en saveCompanyBtn:", generalError);
                    showToast(`Error: ${generalError.message}`, true);
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalButtonHTML;
                    if (document.body.contains(saveButton)) {
                         lucide.createIcons({ nodes: [saveButton.querySelector('i')] });
                    }
                }
            }); // Fin listener de guardado

            // Listener popstate (sin cambios)
            window.addEventListener('popstate', (event) => {
                 if (modal.classList.contains('active')) {
                     modal.classList.remove('active');
                 }
            }, { once: true });
        } // Fin showCompanyFormModal

        // --- Event Listeners Globales ---
        function setupSuperAdminEventListeners() {
            // Limpia listeners anteriores para evitar duplicados
            const oldLogoutBtn = document.getElementById('logout-btn');
            const newLogoutBtn = oldLogoutBtn.cloneNode(true); // Clona para limpiar listeners
            oldLogoutBtn.parentNode.replaceChild(newLogoutBtn, oldLogoutBtn);
            newLogoutBtn.addEventListener('click', async () => {
                showToast('Cerrando sesión...', false);
                try {
                    await signOut(auth);
                    // onAuthStateChanged se encargará de mostrar el login
                    console.log("Logout OK");
                } catch (error) {
                    console.error("Error en Logout:", error);
                    showToast('Error al cerrar sesión.', true);
                }
            });

            const oldAddBtn = document.getElementById('addCompanyBtn');
            const newAddBtn = oldAddBtn.cloneNode(true);
            oldAddBtn.parentNode.replaceChild(newAddBtn, oldAddBtn);
            newAddBtn.addEventListener('click', () => {
                showCompanyFormModal(); // Abre en modo creación
            });
        }


        // --- Toast/Notificaciones ---
        function showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (isError) toast.classList.add('toast-error');
            // else toast.classList.add('toast-success'); // Opcional para éxito
            toast.textContent = message;
            container.appendChild(toast);

            // Forzar reflow para activar la animación de entrada
            void toast.offsetWidth;

            toast.classList.add('show');

            // Ocultar después de 3 segundos
            setTimeout(() => {
                toast.classList.remove('show');
                // Eliminar del DOM después de la animación de salida
                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode === container) { // Comprueba si aún existe
                        container.removeChild(toast);
                    }
                }, { once: true });
            }, 3000);
        }

        // --- Inicialización y Autenticación ---
        function initializeAppLogic() {
            // Listener principal de autenticación
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("AuthStateChanged: Usuario autenticado:", user.uid);
                    // --- INICIALIZACIÓN DE FUNCTIONS ---
                    if (!functions) {
                        console.log("Inicializando SDK de Functions...");
                        functions = getFunctions(app); // Inicializa la variable global 'functions'
                    }
                    // --- FIN INICIALIZACIÓN ---

                    // TODO: Añadir verificación de Custom Claim de Super Admin
                    // por ahora, si está logueado, mostramos la app.
                    showSuperAdminApp(user);
                } else {
                    console.log("AuthStateChanged: Usuario NO autenticado.");
                    showLoginView();
                }
            });

             // Solución simple para 'popstate' (reemplazando el 'popstate' anterior)
             window.onpopstate = function(event) {
                // Cerramos CUALQUIER modal de vista completa
                 const activeModal = document.querySelector('.modal-view.active');
                 if (activeModal) {
                     activeModal.classList.remove('active');
                 }
             };
        }

        // --- Punto de Entrada ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppLogic();
        });

    </script>
</body>
</html>

