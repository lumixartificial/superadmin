<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Super Admin Panel</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f1f5f9;
            --surface-light: #ffffff;
            --text-primary-light: #0f172a;
            --text-secondary-light: #64748b;
            --border-light: #e2e8f0;
            --accent-blue: #3b82f6;
            --accent-blue-darker: #2563eb;
            --danger-light: #ef4444;

            --bg-dark: #020617;
            --surface-dark: #0f172a;
            --text-primary-dark: #e2e8f0;
            --text-secondary-dark: #94a3b8;
            --border-dark: #1e293b;
            --danger-dark: #f87171;
        }

        /* Dark mode por defecto */
        body {
            --bg: var(--bg-dark);
            --surface: var(--surface-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --border-color: var(--border-dark);
            --danger-color: var(--danger-dark);
        }

        /* Estilos Light mode (si se implementa toggle) */
        body.light-mode {
             --bg: var(--bg-light);
            --surface: var(--surface-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --border-color: var(--border-light);
            --danger-color: var(--danger-light);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }

        @keyframes pulse { 0%{transform: scale(1); opacity: .9}50%{transform: scale(1.05); opacity: 1}100%{transform: scale(1); opacity: .9} }
        @keyframes subtle-glow { 0%,100%{filter: drop-shadow(0 0 8px rgba(138,43,226,.7))}50%{filter: drop-shadow(0 0 16px rgba(57,255,20,.7))} }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- Estilos Splash Screen (Opcional, pero recomendado) --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg); display: flex; justify-content: center; align-items: center; z-index: 10000; transition: opacity .5s ease-out }
        #splash-screen img { width: 150px; height: 150px; animation: pulse 2.5s infinite ease-in-out }

        /* --- Estilos Login View --- */
        #login-view {
            display: none; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; padding: 20px; background-color: var(--bg);
        }
        .login-card { /* ... (similar a antes, ajusta si quieres) ... */
            background-color: transparent; box-shadow: none; border: none;
            width: 100%; max-width: 400px; text-align: center;
        }
        .login-card .logo img { width: 100px; height: 100px; margin-bottom: 20px; filter: grayscale(50%) opacity(80%); } /* Logo diferente o con filtro */
        .login-card h2 { margin-bottom: 10px; font-size: 1.6em; font-weight: 700; color: var(--text-primary); }
        .login-card p { margin-bottom: 30px; color: var(--text-secondary); }
        .login-card .form-group { text-align: left; margin-bottom: 15px; }
        .login-card .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-secondary); font-size: 0.9em; }
        .login-card .form-group input { /* ... (similar a antes) ... */
             width: 100%; padding: 12px; font-size: 1em; border-radius: 8px;
             border: 1px solid var(--border-color); background-color: var(--surface); color: var(--text-primary);
             transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-card .form-group input:focus { /* ... (similar a antes) ... */
             border-color: var(--accent-blue); outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .login-card .btn-primary { /* ... (similar a antes) ... */
            width: 100%; padding: 12px; font-size: 1em; font-weight: 600; border: none; border-radius: 8px;
            cursor: pointer; background-color: var(--accent-blue); color: white; transition: background-color 0.2s; margin-top: 10px;
        }
        .login-card .btn-primary:hover { background-color: var(--accent-blue-darker); }
        .login-card .btn-primary:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }

        /* --- Estilos App Container (Placeholder) --- */
        #app-container { display: none; flex-direction: column; height: 100%; width: 100%; }
        .main-header { /* ... (similar a antes, ajusta textos/iconos) ... */
            display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
            background-color: var(--surface); border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .header-title { font-size: 1.2em; font-weight: 600; color: var(--text-primary); }
        .header-controls button { /* ... (estilo botón logout) ... */
            background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        main { flex-grow: 1; overflow-y: auto; }
        .container { padding: 20px; }
        .section-title { font-size: 1.3em; font-weight: 600; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .fab { /* ... (estilo FAB para añadir empresa) ... */
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: var(--accent-blue);
            color: white; border-radius: 50%; border: none; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 160;
        }
        /* --- Otros estilos generales (botones, modales, etc.) --- */
        .btn-primary { background-color: var(--accent-blue); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        .btn-secondary { background-color: transparent; color: var(--accent-blue); border: 1px solid var(--accent-blue); padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        .btn-danger { background-color: var(--danger-color); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        
        /* --- ESTILOS CORREGIDOS PARA MODALES --- */
        .modal-view, .modal-overlay { 
            position: fixed; /* Asegura posición fija */
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 200; /* Pone el modal por encima */
        }
        .modal-view { 
            background-color: var(--bg); 
            transform: translateX(100%); /* Empieza fuera de pantalla */
            transition: transform 0.3s ease-in-out; 
            display: flex; 
            flex-direction: column; 
        }
        .modal-view.active { 
            transform: translateX(0); /* Lo trae a la pantalla */
        }
        .modal-overlay { 
            background-color: rgba(0,0,0,0.6); 
            backdrop-filter: blur(4px); 
            display: none; /* Oculto por defecto */
            justify-content: center; 
            align-items: center; 
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
         }
         .modal-overlay.active { 
             display: flex; /* Muestra */
             opacity: 1; 
         }
         .modal-content { 
             background-color: var(--surface); 
             padding: 20px; 
             border-radius: 12px; 
             width: 90%; 
             max-width: 500px; 
             box-shadow: 0 10px 30px rgba(0,0,0,0.2);
         }
         .modal-header { 
             display: flex; align-items: center; padding: 15px 20px; 
             background-color: var(--surface); border-bottom: 1px solid var(--border-color); 
             flex-shrink: 0; position: sticky; top: 0; z-index: 1; /* Para que quede arriba al hacer scroll */
         }
         .modal-header button { background: none; border: none; color: var(--text-primary); cursor: pointer; margin-right: 15px; }
         .modal-title { font-size: 1.2em; font-weight: 600; }
         .modal-content-wrapper { flex-grow: 1; overflow-y: auto; }
         .action-buttons { 
             background-color: var(--surface); border-top: 1px solid var(--border-color); 
             padding: 15px 20px; display: flex; gap: 10px; margin-top: auto; 
             position: sticky; bottom: 0; flex-shrink: 0; 
         }
         .action-buttons button { flex-grow: 1; padding: 12px; font-size: 1em; font-weight: 600; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
         .action-buttons button:disabled { background-color: var(--text-secondary); cursor: not-allowed; opacity: 0.7; }
         /* --- FIN ESTILOS CORREGIDOS MODALES --- */

        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .toast { background-color: #333; color: white; padding: 10px 18px; border-radius: 6px; box-shadow: 0 3px 10px rgba(0,0,0,0.2); font-size: 0.9em; opacity: 0; transform: translateY(-15px); transition: opacity .3s, transform .3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.toast-error { background-color: var(--danger-color); }
        .toast.toast-success { background-color: var(--accent-blue); } /* Ajusta color si quieres */

        /* Estilos específicos del formulario de empresa */
        #companyFormModal .form-group { margin-bottom: 18px; }
        #companyFormModal .form-group label { margin-bottom: 6px; font-size: 0.9em; }
        #companyFormModal .form-group input, 
        #companyFormModal .form-group select, 
        #companyFormModal .form-group textarea { padding: 10px; }
        #companyFormModal .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        #companyFormModal .toggle-switch { /* ... estilos toggle ... */ }
        #companyFormModal .section-title { margin-top: 25px; margin-bottom: 15px; padding-bottom: 8px; font-size: 1.1em; }

        /* Estilos para lista de empresas */
        #companies-list .company-card { 
             background-color: var(--surface); padding: 15px 20px; border-radius: 8px; 
             margin-bottom: 12px; border: 1px solid var(--border-color); 
             display: flex; justify-content: space-between; align-items: center;
             cursor: pointer; transition: box-shadow 0.2s, transform 0.2s;
        }
        #companies-list .company-card:hover { 
             transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        body.dark-mode #companies-list .company-card:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); /* Sombra azulada en modo oscuro */
        }
        #companies-list .company-card h4 { margin: 0 0 4px; font-size: 1.1em; }
        #companies-list .company-card p { font-size: 0.85em; color: var(--text-secondary); margin: 0; }
        #companies-list .company-card .company-actions button { /* Estilo botones editar/ver */ }

    </style>
</head>
<body>

    <div id="splash-screen" style="display: none;"> <!-- Opcional -->
        <img src="URL_DE_TU_LOGO_SI_QUIERES" alt="Loading...">
    </div>

    <div id="login-view">
        <div class="login-card">
            <div class="logo">
                <img src="https://res.cloudinary.com/dc6as14p0/image/upload/v1759611967/LOGO---LUMIX-FINANZAS-REDUCIDO_gc8zow.png" alt="Logo"> <!-- Usa tu logo -->
            </div>
            <h2>Super Admin Panel</h2>
            <p>Acceso exclusivo.</p>
            <form id="login-form">
                <div class="form-group">
                    <label for="superadmin-email">Email</label>
                    <input type="email" id="superadmin-email" required>
                </div>
                <div class="form-group">
                    <label for="superadmin-password">Contraseña</label>
                    <input type="password" id="superadmin-password" required>
                </div>
                <button type="submit" class="btn-primary">Entrar</button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <header class="main-header">
            <span class="header-title">Gestión de Empresas</span>
            <div class="header-controls">
                <button id="logout-btn" title="Cerrar Sesión"><i data-lucide="log-out"></i></button>
            </div>
        </header>
        <main>
            <div id="companies-view" class="view active container">
                <h2 class="section-title">Empresas Registradas</h2>
                <div id="companies-list">
                    <p>Cargando empresas...</p>
                    <!-- La lista de empresas se cargará aquí -->
                </div>
            </div>
            <!-- Aquí irán otras vistas si son necesarias -->
        </main>
        <button class="fab" id="addCompanyBtn" title="Añadir Nueva Empresa"><i data-lucide="plus"></i></button>
    </div>

    <!-- Modales -->
    <div id="companyFormModal" class="modal-view"></div>
    <div id="toast-container"></div>

    <script type="module">
        // Importa Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-functions.js";

        // --- Configuración de Firebase (Usa la MISMA que tus otras apps) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBRxJjpH6PBi-GRxOXS8klv-8v91sO4X-Y",
            authDomain: "lumix-financas-app.firebaseapp.com",
            projectId: "lumix-financas-app",
            storageBucket: "lumix-financas-app.firebasestorage.app", // O .appspot.com si es el caso
            messagingSenderId: "463777495321",
            appId: "1:463777495321:web:106118f53f56abd206ed88" // Asegúrate que sea el correcto
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        // --- Variables Globales ---
        let allCompanies = [];
        let currentSuperAdmin = null;

        // --- Funciones Principales (Implementación básica) ---

        async function handleSuperAdminLogin(event) {
            event.preventDefault();
            const emailInput = document.getElementById('superadmin-email');
            const passwordInput = document.getElementById('superadmin-password');
            const loginButton = document.querySelector('#login-form button[type="submit"]');
            const originalButtonHTML = loginButton.innerHTML;
            const email = emailInput.value.trim();
            const pass = passwordInput.value;

            if (!email || !pass) { showToast('Email y contraseña requeridos.', true); return; }

            loginButton.disabled = true;
            loginButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite; margin-right: 8px;"></i> Entrando...`;
            lucide.createIcons({ nodes: [loginButton.querySelector('i')] });


            try {
                // Intenta iniciar sesión
                const userCredential = await signInWithEmailAndPassword(auth, email, pass);
                // IMPORTANTE: Aquí deberíamos verificar si este usuario es REALMENTE un Super Admin.
                // Por ahora, asumiremos que si logra iniciar sesión en esta app, lo es.
                // La verificación real se haría con Custom Claims (más adelante).
                console.log("Login Super Admin OK:", userCredential.user.uid);
                // onAuthStateChanged se encargará del resto

            } catch (error) {
                console.error("Error Login Super Admin:", error);
                showToast('Email o contraseña incorrectos.', true);
                loginButton.disabled = false;
                loginButton.innerHTML = originalButtonHTML;
            }
        }

        function showSuperAdminApp(user) {
            currentSuperAdmin = user; // Guarda el usuario Super Admin
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            // Llama a funciones para cargar datos y configurar listeners
            loadCompanies();
            setupSuperAdminEventListeners();
            lucide.createIcons();
        }

        function showLoginView() {
            currentSuperAdmin = null;
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-view').style.display = 'flex';
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.removeEventListener('submit', handleSuperAdminLogin); // Limpia anterior
                loginForm.addEventListener('submit', handleSuperAdminLogin);
            }
            // Asegura íconos en login si tienes alguno
            const loginViewIcons = document.getElementById('login-view').querySelectorAll('[data-lucide]');
            if(loginViewIcons.length > 0) lucide.createIcons({nodes: loginViewIcons});
        }

        function loadCompanies() {
            const listContainer = document.getElementById('companies-list');
            listContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Cargando...</p>'; // Indicador de carga mejorado

            // Escucha la colección /companies
            onSnapshot(collection(db, 'companies'), (snapshot) => {
                allCompanies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCompaniesList();
            }, (error) => {
                console.error("Error al cargar empresas:", error);
                listContainer.innerHTML = '<p style="text-align: center; color: var(--danger-color); padding: 20px;">Error al cargar datos.</p>';
            });
        }

        function renderCompaniesList() {
            const listContainer = document.getElementById('companies-list');
            if (allCompanies.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px 20px;">No hay empresas registradas todavía. Haz clic en el botón "+" para añadir la primera.</p>';
                return;
            }
            // Lista mejorada con estilo de tarjeta
            listContainer.innerHTML = allCompanies.map(company => `
                <div class="company-card" data-company-id="${company.id}">
                    <div>
                        <h4>${company.name || 'Nombre no definido'}</h4>
                        <p>Plan: ${company.plan?.text || company.plan?.duration || 'N/A'} - Valor: ${company.plan?.value || 'N/A'}</p> 
                    </div>
                    <div>
                        <button class="header-btn" data-action="edit" title="Editar Empresa"><i data-lucide="edit"></i></button>
                        <!-- <button class="header-btn" data-action="view" title="Ver Detalles"><i data-lucide="eye"></i></button> -->
                    </div>
                </div>
            `).join('');
            // Añade listeners a los nuevos botones
             listContainer.querySelectorAll('.company-card button[data-action="edit"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita que el clic en el botón active el clic en la tarjeta
                    const companyId = e.currentTarget.closest('.company-card').dataset.companyId;
                    showCompanyFormModal(companyId); // Abre modal en modo edición
                });
            });
             // Listener para la tarjeta completa (podría llevar a una vista de detalles en el futuro)
            listContainer.querySelectorAll('.company-card').forEach(card => {
                card.addEventListener('click', (e) => {
                     if (e.target.closest('button')) return; // No hacer nada si se hizo clic en un botón
                     const companyId = card.dataset.companyId;
                     console.log("Ver detalles de la empresa (Implementación futura):", companyId);
                     showToast(`Ver detalles de ${allCompanies.find(c=>c.id===companyId)?.name} (Implementación futura)`, false)
                });
            });

            lucide.createIcons({ nodes: listContainer.querySelectorAll('[data-lucide]') });
        }

        function showCompanyFormModal(companyId = null) {
    const isEditMode = companyId !== null;
    const companyData = isEditMode ? allCompanies.find(c => c.id === companyId) : {}; // Obtiene datos si edita
    // En modo edición, no podemos editar el admin inicial aquí, solo datos de la empresa/plan

    const modal = document.getElementById('companyFormModal');
    if (!modal) return;

    const modalTitle = isEditMode ? 'Editar Empresa' : 'Registrar Nova Empresa Financeira';
    const saveButtonText = isEditMode ? 'Salvar Alterações' : 'Criar Empresa e Admin';

    // Opciones de planes
    const planOptions = [
        { value: '1m', text: '1 Mês' },
        { value: '3m', text: '3 Meses' },
        { value: '6m', text: '6 Meses' },
        { value: '1y', text: '1 Ano' },
        { value: '3y', text: '3 Anos' }
    ];

    modal.innerHTML = `
        <header class="modal-header">
            <button id="closeCompanyFormModal"><i data-lucide="arrow-left"></i></button>
            <span class="modal-title">${modalTitle}</span>
        </header>
        <div class="modal-content-wrapper container">
            <form id="company-form">

                <h3 class="section-title" style="margin-top: 10px; font-size: 1.1em;">Dados da Empresa</h3>

                <div class="form-group">
                    <label for="company-name">Nome da Empresa Financeira</label>
                    <input type="text" id="company-name" required value="${companyData.name || ''}">
                </div>

                <!-- Configurações Iniciais Opcionais -->
                <div class="form-group grid-2">
                    <div>
                        <label for="company-default-interest">Juros Padrão (%)</label>
                        <input type="number" id="company-default-interest" step="0.1" value="${companyData.settings?.defaultInterest || '20'}">
                    </div>
                    <div>
                        <label for="company-currency">Moeda Principal</label>
                        <select id="company-currency">
                             <!-- Aquí podrías poblar con tus CURRENCY_CONFIGS si las traes a esta app -->
                             <option value="BRL" ${ (companyData.settings?.currency || 'BRL') === 'BRL' ? 'selected' : '' }>BRL (Real)</option>
                             <option value="COP" ${ (companyData.settings?.currency || 'BRL') === 'COP' ? 'selected' : '' }>COP (Peso Col.)</option>
                             <option value="USD" ${ (companyData.settings?.currency || 'BRL') === 'USD' ? 'selected' : '' }>USD (Dólar)</option>
                             <!-- Añade más monedas si es necesario -->
                        </select>
                    </div>
                </div>
                <div class="form-group" style="display: none;"> <!-- Ocultamos el toggle por ahora -->
                     <label class="toggle-switch" style="justify-content: flex-start; gap: 10px;">
                        <input type="checkbox" id="company-require-gps" ${companyData.settings?.requireGps ? 'checked' : ''}>
                        <span class="slider"></span>
                        <span>Exigir GPS dos Cobradores</span>
                     </label>
                </div>


                <h3 class="section-title" style="margin-top: 30px; font-size: 1.1em;">Plano e Pagamento</h3>

                <div class="form-group grid-2">
                    <div>
                        <label for="company-plan-duration">Duração do Plano</label>
                        <select id="company-plan-duration">
                            ${planOptions.map(opt => `<option value="${opt.value}" ${companyData.plan?.duration === opt.value ? 'selected' : ''}>${opt.text}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="company-plan-value">Valor (Mensalidade/Período)</label>
                        <input type="number" id="company-plan-value" step="0.01" required value="${companyData.plan?.value || ''}" placeholder="Ex: 150.00">
                    </div>
                </div>

                <!-- Solo mostramos campos de Admin al CREAR -->
                ${!isEditMode ? `
                <h3 class="section-title" style="margin-top: 30px; font-size: 1.1em;">Dados do Administrador Principal</h3>

                <div class="form-group">
                    <label for="admin-email">Email do Admin</label>
                    <input type="email" id="admin-email" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="admin-password">Senha Temporária do Admin</label>
                    <input type="password" id="admin-password" required autocomplete="new-password">
                    <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 5px;">Mínimo 6 caracteres. O admin deverá alterá-la no primeiro acesso.</p>
                </div>
                ` : ''}

            </form>
        </div>
        <div class="action-buttons">
            <button id="saveCompanyBtn" class="btn-primary"><i data-lucide="save"></i> ${saveButtonText}</button>
        </div>
    `;

    // Añade estado al historial y muestra el modal
    history.pushState({ modal: 'companyFormModal' }, modalTitle, '#company-form');
    modal.classList.add('active');
    lucide.createIcons({ nodes: modal.querySelectorAll('[data-lucide]') });

    // --- Event Listeners del Modal ---
    modal.querySelector('#closeCompanyFormModal').addEventListener('click', () => window.history.back());
    modal.querySelector('#saveCompanyBtn').addEventListener('click', async (e) => {
        const saveButton = e.currentTarget;
        const originalButtonHTML = saveButton.innerHTML;

        // 1. Recolectar datos del formulario
        const companyName = document.getElementById('company-name').value.trim();
        const defaultInterest = parseFloat(document.getElementById('company-default-interest').value) || 20;
        const currency = document.getElementById('company-currency').value || 'BRL';
        const requireGps = document.getElementById('company-require-gps').checked; // Aunque oculto, lo leemos
        const planDurationSelect = document.getElementById('company-plan-duration');
        const planDuration = planDurationSelect.value;
        const planDurationText = planDurationSelect.options[planDurationSelect.selectedIndex].text; // Guardamos el texto también
        const planValueInput = document.getElementById('company-plan-value');
        const planValue = parseFloat(planValueInput.value);

        const adminEmailInput = document.getElementById('admin-email'); // Puede ser null si isEditMode
        const adminPasswordInput = document.getElementById('admin-password'); // Puede ser null si isEditMode
        const adminEmail = adminEmailInput ? adminEmailInput.value.trim() : null;
        const adminPassword = adminPasswordInput ? adminPasswordInput.value : null;

        // Validaciones básicas
        if (!companyName || isNaN(planValue) || planValue <= 0) {
            showToast('Nome da empresa e valor do plano são obrigatórios.', true);
            return;
        }
        if (!isEditMode && (!adminEmail || !adminPassword || adminPassword.length < 6)) {
            showToast('Email e senha (mín. 6 caracteres) para o admin são obrigatórios.', true);
            return;
        }

        // Deshabilita botón y muestra carga
        saveButton.disabled = true;
        saveButton.innerHTML = `<i data-lucide="loader-circle" style="animation: spin 1s linear infinite;"></i> ${isEditMode ? 'Salvando...' : 'Criando...'}`;
        lucide.createIcons({ nodes: [saveButton.querySelector('i')] });

        // 2. Preparar datos para Firestore y Cloud Function
        const companySettings = { defaultInterest, currency, requireGps };
        const companyPlan = { duration: planDuration, text: planDurationText, value: planValue, startDate: serverTimestamp() }; // Añadimos fecha y texto

        const companyBaseData = {
            name: companyName,
            settings: companySettings,
            plan: companyPlan,
            // adminUserIds se llenará/actualizará desde la Cloud Function
            // createdAt se añadirá desde la Cloud Function al crear
        };

        try {
            if (isEditMode) {
                // --- Lógica de Edición (Directo a Firestore) ---
                console.log("Modo Edição - Atualizando dados da empresa em Firestore...");
                const companyRef = doc(db, 'companies', companyId);
                // Solo actualizamos los campos modificables
                await updateDoc(companyRef, {
                     name: companyBaseData.name,
                     settings: companyBaseData.settings,
                     plan: companyBaseData.plan // Actualizamos el plan completo
                });
                showToast('Empresa atualizada com sucesso!');
                window.history.back(); // Cierra el modal

            } else {
                // --- Lógica de Creación (Llamada a Cloud Function) ---
                console.log("Modo Criação - Chamando Cloud Function...");

                // --- Llamada Real a la Cloud Function ---
                try {
                    console.log("Chamando Cloud Function 'createCompanyAndAdmin'...");
                    const createCompanyFunction = httpsCallable(functions, 'createCompanyAndAdmin');
                    const result = await createCompanyFunction({
                        companyData: companyBaseData,
                        adminEmail: adminEmail,
                        adminPassword: adminPassword
                    });

                    console.log("Resultado da Cloud Function:", result.data);

                    if (result.data.success) {
                        showToast(`Empresa "${companyName}" e Admin criados com sucesso! ID: ${result.data.companyId}`);
                        window.history.back(); // Cierra el modal si fue exitoso
                    } else {
                        throw new Error(result.data.error || 'Erro desconhecido retornado pela Cloud Function.');
                    }

                } catch (functionError) {
                    console.error("Erro ao chamar/executar a Cloud Function:", functionError);
                    let detailedErrorMessage = 'Falha ao criar a empresa. Verifique os logs da Cloud Function.';
                    if (functionError.code && functionError.message) {
                        detailedErrorMessage = `Erro (${functionError.code}): ${functionError.message}`;
                    } else if (functionError.message) {
                        detailedErrorMessage = functionError.message;
                    }
                    showToast(detailedErrorMessage, true);
                }
                // --- Fin Llamada Real ---
            }
        } catch (error) { // Catch para errores generales (como fallo de red en updateDoc)
            console.error("Erro geral ao salvar/criar empresa:", error);
            showToast(`Erro: ${error.message || 'Ocorreu um problema.'}`, true);
        } finally {
            // Rehabilita el botón independientemente del resultado
            saveButton.disabled = false;
            saveButton.innerHTML = `<i data-lucide="save"></i> ${saveButtonText}`;
            lucide.createIcons({ nodes: [saveButton.querySelector('i')] });
        }
    }); // Fin listener saveCompanyBtn

} // Fin showCompanyFormModal

        function setupSuperAdminEventListeners() {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                // Remove listener anterior para evitar duplicados al recargar
                logoutBtn.removeEventListener('click', handleLogout); 
                logoutBtn.addEventListener('click', handleLogout);
            }
            const addCompanyBtn = document.getElementById('addCompanyBtn');
            if (addCompanyBtn) {
                 // Remove listener anterior
                addCompanyBtn.removeEventListener('click', handleAddCompanyClick);
                addCompanyBtn.addEventListener('click', handleAddCompanyClick);
            }
            // Listener de historial para modales (Back button)
             window.removeEventListener('popstate', handlePopState); // Limpia anterior
             window.addEventListener('popstate', handlePopState);
        }

        // Funciones handler separadas para poder remover listeners
        function handleLogout() {
             signOut(auth).catch(err => console.error("Error al cerrar sesión Super Admin:", err));
        }
        function handleAddCompanyClick() {
            showCompanyFormModal();
        }
        function handlePopState(event) {
             // Cierra todos los modales si el usuario navega hacia atrás
             document.querySelectorAll('.modal-view.active').forEach(modal => {
                 modal.classList.remove('active');
             });
             // Si el estado era de un modal, ya está cerrado. Si no, onAuthStateChanged manejará la vista.
        }

        function showToast(message, isError = false) {
             const container = document.getElementById('toast-container');
             const toast = document.createElement('div');
             toast.className = `toast ${isError ? 'toast-error' : 'toast-success'}`;
             toast.textContent = message;
             container.appendChild(toast);
             setTimeout(() => toast.classList.add('show'), 10);
             setTimeout(() => {
                 toast.classList.remove('show');
                 setTimeout(() => toast.remove(), 300); // Reduce tiempo de remoción
             }, isError ? 4000 : 2500); // Más tiempo para errores
        }

        // --- Inicialización ---
        function initSuperAdmin() {
            onAuthStateChanged(auth, (user) => {
                // Aquí podríamos añadir la verificación de Custom Claims si ya la tuviéramos
                if (user) {
                    // **VERIFICACIÓN SUPER ADMIN (IMPORTANTE)**
                    // Necesitamos asegurarnos de que solo TU cuenta pueda usar esta app.
                    // Comparamos el UID logueado con tu UID de Super Admin.
                    const SUPER_ADMIN_UID = "4o3DgFdtLdfOdIqltUH90Sk3Rsi1"; // TU UID
                    if (user.uid === SUPER_ADMIN_UID) {
                        showSuperAdminApp(user);
                    } else {
                        // Si es otro usuario logueado (quizás un Admin normal), lo deslogueamos
                        console.warn("Intento de acceso de usuario no Super Admin:", user.uid);
                        signOut(auth); // Desloguea al usuario no autorizado
                        showLoginView(); // Muestra el login
                        showToast("Acceso denegado. Solo el Super Admin puede entrar.", true);
                    }
                } else {
                    showLoginView(); // Muestra el login si no hay nadie logueado
                }
            });
        }

        initSuperAdmin(); // Llama a la inicialización

    </script>
</body>
</html>
